name: Release

on:
  push:
    branches: [main]
    paths:
      - "charts/**"
      - ".releaserc.json"

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: azure/setup-helm@v4
        with:
          version: "3.17.0"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install semantic-release
        run: |
          npm install -g semantic-release \
            @semantic-release/changelog \
            @semantic-release/exec \
            conventional-changelog-conventionalcommits

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Check if new release was created
        id: check
        run: |
          CHART_VERSION=$(helm show chart charts/n8n | grep '^version:' | awk '{print $2}')
          echo "version=$CHART_VERSION" >> "$GITHUB_OUTPUT"
          TAG_COMMIT=$(git rev-list -n 1 "v$CHART_VERSION" 2>/dev/null || echo "")
          HEAD_COMMIT=$(git rev-parse HEAD)
          if [ -n "$TAG_COMMIT" ] && [ "$TAG_COMMIT" = "$HEAD_COMMIT" ]; then
            echo "released=true" >> "$GITHUB_OUTPUT"
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR
        if: steps.check.outputs.released == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Package and push to GHCR
        if: steps.check.outputs.released == 'true'
        run: |
          CHART_VERSION="${{ steps.check.outputs.version }}"
          helm package charts/n8n --destination /tmp/chart-pkg/
          helm push "/tmp/chart-pkg/n8n-${CHART_VERSION}.tgz" oci://ghcr.io/n8n-io

      - name: Open PR to update repo files
        if: steps.check.outputs.released == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHART_VERSION: ${{ steps.check.outputs.version }}
        run: |
          BRANCH="automated/release-v${CHART_VERSION}"
          git checkout -B "$BRANCH"
          git add charts/n8n/Chart.yaml CHANGELOG.md
          git commit -m "chore(release): v${CHART_VERSION} [skip ci]"
          git push origin "$BRANCH"
          gh pr create \
            --title "chore(release): v${CHART_VERSION}" \
            --body "Automated update of Chart.yaml version and CHANGELOG.md from release v${CHART_VERSION}." \
            --base main
